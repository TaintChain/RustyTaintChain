/*! vizuly 05-06-2017 */
vizuly.viz.weighted_tree=function(a){function b(){l.selection.attr("class","vz-weighted_tree-viz"),w=l.selection.append("svg").attr("id",l.id).style("overflow","visible").attr("class","vizuly vz-weighted_tree-viz"),D=vizuly.core.util.getDefs(o),y=w.append("rect").attr("class","vz-background"),x=w.append("g").attr("class","vz-weighted_tree-viz"),z=x.append("g").attr("class","vz-weighted_tree-plot"),A=z.append("rect").attr("class","vz-plot-background"),B=z.append("g").attr("class","vz-weighted_tree-link-plot"),C=z.append("g").attr("class","vz-weighted_tree-node-plot"),l.dispatch.initialize()}function c(){function a(b){b.children&&(b._children=b.children,b._children.forEach(a),b.children=null)}o.validate(),r=vizuly.core.util.size(l.margin,l.width,l.height),E.size([r.height,r.width]),(1==p||q)&&(d(),1==p&&s.children.forEach(a),p=!1,q=!1);var b;-1==l.branchPadding?(b=Math.min(r.height,r.width)/l.children(l.data).length,console.log("scale = "+b)):b=Math.min(r.height,r.width)*l.branchPadding,F.range([1.5,b/2]),E.nodeSize([b,0]),u=l.fixedSpan>0?l.fixedSpan:r.width/(v+1);for(var c=1;v+1>c;c++){var e=t.filter(function(a){return a.depth==c});G[c]=d3.max(e,function(a){return l.value(a)}),H[c]=d3.min(e,function(a){return l.value(a)})}l.dispatch.measure()}function d(){function a(b){l.children(b)&&(b._children||(b.children=l.children(b),b.children.forEach(function(c){c.x0=b.x,c.y0=b.y,a(c)})))}v=0,a(l.data),s=l.data,s.x0=0,s.y0=0,t=E.nodes(s).reverse(),t.forEach(function(a){0!=a.depth&&(G[a.depth]||(G[a.depth]=-(1/0),H[a.depth]=1/0),v=Math.max(v,a.depth))}),l.dispatch.data_prepped()}function e(){p=!0}function f(a){c(),w.attr("width",l.width).attr("height",l.height),y.attr("width",l.width).attr("height",l.height),z.style("width",r.width).style("height",r.height).attr("transform","translate("+r.left+","+(r.top+r.height/2)+")"),g(s)}function g(a){var b=E(s).reverse(),c=E.links(b);h(a,b);var d=C.selectAll(".vz-weighted_tree-node").data(b,function(a){return a.vz_tree_id||(a.vz_tree_id=l.key(a))}),e=d.enter().append("g").attr("class",function(a){return"vz-weighted_tree-node vz-id-"+a.vz_tree_id}).attr("transform",function(b){var c=b.y0?b.y0:a.y0,d=b.x0?b.x0:a.x0;return"translate("+c+","+d+")"}).on("click",function(a,b){l.dispatch.click(this,a,b)}).on("dblclick",function(a,b){l.dispatch.dblclick(this,a,b)}).on("mouseover",function(a,b){l.dispatch.mouseover(this,a,b)}).on("mouseout",function(a,b){l.dispatch.mouseout(this,a,b)});e.append("circle").attr("class",".vz-weighted_tree-node-circle").attr("r",1e-6).style("cursor","pointer"),e.append("text").attr("x",function(a){return a.children||a._children?-10:10}).attr("dy",".35em").attr("text-anchor",function(a){return a.children||a._children?"end":"start"}).style("pointer-events","none").text(function(a){return l.label(a)});var f=B.selectAll(".vz-weighted_tree-link").data(c,function(a){return a.target.vz_tree_id});f.enter().append("path").attr("class",function(a){return"vz-weighted_tree-link vz-id-"+a.target.vz_tree_id}).attr("d",function(b){var c=b.target.y0?b.target.y0:a.y0,d=b.target.x0?b.target.x0:a.x0,e={x:d,y:c};return I({source:e,target:e})}).on("mouseover",function(a,b){l.dispatch.mouseover(this,a,b)}).on("mouseout",function(a,b){l.dispatch.mouseout(this,a,b)}).style("stroke-linecap","round"),l.dispatch.update();var g=d.transition();i(g,function(){l.dispatch.node_refresh()}),g.duration(l.duration).attr("transform",function(a){return"translate("+a.y+","+a.x+")"}),g.select("circle").attr("r",function(a){return J(a)});var j=d.exit().transition().duration(l.duration).attr("transform",function(b){return b.x0=null,b.y0=null,"translate("+a.y+","+a.x+")"}).remove();j.select("circle").attr("r",1e-6),j.select("text"),f.transition().duration(l.duration).attr("d",I).style("stroke-width",function(a){return 2*J(a.target)}),f.exit().transition().duration(l.duration).attr("d",function(b){var c={x:a.x,y:a.y};return I({source:c,target:c})}).remove(),b.forEach(function(a){a.x0=a.x,a.y0=a.y})}function h(a,b){var c=d3.min(b,function(a){return a.x}),d=d3.max(b,function(a){return a.x}),e=d3.max(b,function(a){return a.depth})*u,f=Math.max(l.height,d-c+r.top),g=Math.max(l.width,e+.2*l.width+r.left);r.height/2+d>f&&(f=r.height/2+d+E.nodeSize()[0]),w.transition().duration(l.duration).style("height",f+"px").style("width",g+"px");var h=Math.max(0,-c-r.height/2)+E.nodeSize()[0]/2;b.forEach(function(a){a.y=a.depth*u,a.x=a.x+h-E.nodeSize()[0]}),j(a.x)}function i(a,b){var c=0;a.each(function(){++c}).each("end",function(){--c||b.apply(this,arguments)})}function j(a){function b(a){return function(){var b=d3.interpolateNumber(this.scrollTop,a);return function(a){this.scrollTop=b(a)}}}l.selection.transition().duration(l.duration).tween("scrolltween",b(a))}function k(a){a.children?(a._children=a.children,a.children=null):(a.children=a._children,a._children=null),g(a)}var l={},m={data:null,margin:{top:"5%",bottom:"5%",left:"8%",right:"7%"},width:600,height:600,key:null,tree:d3.layout.tree(),children:null,duration:500,value:null,label:n,branchPadding:-1,fixedSpan:-1},n=function(a,b){return a},o=vizuly.core.component(a,l,m,["node_refresh","data_prepped"]);o.type="viz.chart.weighted_tree";var p=!0,q=!1;o.on("data_change.internal",e);var r,s,t,u,v,w,x,y,z,A,B,C,D,E=l.tree,F=d3.scale.sqrt(),G={},H={},I=d3.svg.diagonal().projection(function(a){return[a.y,a.x]}),J=function(a){return 0==a.depth?F.range()[1]/2:(F.domain([H[a.depth],G[a.depth]]),F(l.value(a)))};return b(),o.update=function(a){return 1==a&&(q=!0),f(),o},o.toggleNode=function(a){k(a)},o};